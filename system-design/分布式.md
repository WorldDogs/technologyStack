# 分布式

## 引言

分布式事务是分布式系统必不可少的组成部分。本文从分布式事务切入，对分布式最底层的原理·进行剖析包括但不限于**BASE原则、两阶段原子提交协议、三阶段原子提交协议、分布式共识算法的原理和证明、Raft分布式共识研发、分布式事务的并发控制**。

## 事务

事务由有限的操作序列组成，操作序列被看成不可分割的整体，要么全部操作成功，要么是没执行状态。事务最早由DBMS引入，数据库事务严格遵循ACID原则，属于刚性事务。一开始数据库事务仅限于对单一数据库资源对象的访问控制，这一类事务被称为本地事务，分布式系统的出现，数据存储不可避免的走向了分布式，分布式事务应运而生。

### 刚性事务

完全遵循ACID规范，即数据库事务的4大基本特性。

A原子性：操作序列作为整体不可分割，执行后的状态要么是每一条都成功要么和没执行一样。

C一致性: 数据一致性没有被破坏

I隔离性：多个事务之间并发执行不会由于交叉处理数据导致数据不一致。事务隔离又分为不同级别：读已提交，读未提交，可重复读，序列化

D持久性：事务执行后对数据的修改是永久的即使系统故障也不会丢失。



### 柔性事务

柔性事务基于分布式CAP理论以及延伸出来的BASE理论，柔性事务保证的是基本可用最终一致。

**BASE原则:**

* 基本可用(**B**asically **A**vailable): 系统能够基本运行、一直提供服务
* 软状态(**S**oft-state): 系统不要求保证强一致状态
* 最终一致性(Eventual Consistentcy)：系统需要在某一时刻后达到一致性要求

### 本地事务

仅仅对单一资源进行访问更新,一般来说使用刚性事务。

### 分布式事务

事务一般分为以下两种

* 平面事务
  * 访问多个节点的资源对象，一个平面事务请求完成后才能发起下一个请求
* 嵌套事务
  * 多事务做成，下层事务可以不断创建子事务

分布式事务要解决的两个核心问题：

* 1.管理在多个节点上事务的提交和终止
* 2.规避分布式死锁

针对两个问题的解决方案：

* 对于1涉及到分布式原子提交协议算法，如两阶段提交协议
* 对于2涉及到并发控制机制



## 原子提交协议

原子性是分布式事物的前置约束条件，没有原子性则分布式事务毫无意义。

对于一个分布式事务涉及到的节点，所有的节点要么全部执行事务成功，要么恢复到事务开始前的状态。

满足这种约束的分布式事务协议被称为：**原子提交协议**

过程：当一个事务结束时，事物的原子特性要求所有参与该事务的服务器节点必须全部提交或者全部放弃该事务，为了实现这一点，必须引入一个协调者角色，从参与事务的所有节点中挑选一个协调者，由他决策所有节点节点上最终的结果。

分布式事务中的角色：

* 协调者
* 参与者



### 单阶段原子提交协议

* 优点

简单易用

* 缺点

不允许任何节点单方面放弃事务，事务的放弃只能由协调者决定，在执行期间协调者不会去检查参与者的执行状态。

### 两阶段提交协议

协议工作流程分为两个阶段：

* 准备阶段： 投票表决决断
* 提交阶段：提交阶段

缺点

* 单点故障问题，如果协作者宕机，由于是阻塞协议，参与者得资源会被一直锁定
* 如果没协作者得决策没有通知到某些参与者，会导致数据不一致

### 三阶段提交协议

工作流程

* **CanCommit 阶段 ** 协作者询问参与者是否能够提交
* **PreCommit 阶段 **协作者让参与者去执行(在这里才锁定资源)
* **DoCommit 阶段 **协作者让参与者提交

相对与两阶段提交的优势：

* 增加了超时机制，超时相当于投了反对票
* 如果参与者单点故障，不会锁定资源（因为上来查询参与者的状态）

缺陷：

* 还是没有解决数据不一致问题，发给每一个参与者的指令丢失后，参与者接受指令超时会直接提交，就会导致数据不一致.

## 共识算法

共识算法解决的是分布式系统对提案,大部分节点达成一致意见的过程(可以认为任何可以达成一致得信息都是提案).

### paxos

由proposer,acceptor,learner组成. proposer 提起提案,由acceptor投票表决(半数通过),然后表决结果通知给learner学习.





# reference

[公众号-腾讯技术工程](https://mp.weixin.qq.com/s/KKrxuVCrjlXXWMPTXQ-fvA)

